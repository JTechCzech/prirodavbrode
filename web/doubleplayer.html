<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NVR Double Player</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    width: 100%; height: 100%;
    background: #0a0a0a;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    font-family: 'Segoe UI', sans-serif;
    overflow: hidden;
  }

  /* ── WRAPPER ── */
  .dual-wrap {
    position: relative;
    width: 100vw; height: 100vh;
    display: flex; flex-direction: column;
    user-select: none;
  }

  /* ── VIDEO STAGE ── */
  .video-stage {
    flex: 1;
    display: flex;
    min-height: 0;
  }

  /* landscape: side by side | portrait: stacked */
  @media (orientation: landscape) {
    .video-stage { flex-direction: row; }
  }
  @media (orientation: portrait) {
    .video-stage { flex-direction: column; }
  }

  .video-cell {
    flex: 1;
    position: relative;
    background: #000;
    overflow: hidden;
    min-width: 0; min-height: 0;
  }

  /* thin divider between panels */
  .video-cell:first-child {
    border-right: 1px solid #222;
  }
  @media (orientation: portrait) {
    .video-cell:first-child {
      border-right: none;
      border-bottom: 1px solid #222;
    }
  }

  .video-cell video {
    width: 100%; height: 100%;
    display: block; object-fit: contain;
  }

  /* Label badge */
  .cell-label {
    position: absolute;
    top: 10px; left: 10px;
    background: rgba(0,0,0,0.55);
    color: #fff; font-size: 11px;
    font-weight: 600; letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 3px 8px; border-radius: 4px;
    backdrop-filter: blur(4px);
    pointer-events: none;
    z-index: 5;
  }

  /* ── CONTROLS BAR ── */
  .controls-bar {
    flex-shrink: 0;
    background: #111;
    border-top: 1px solid #1e1e1e;
    padding: 6px 14px 9px;
    display: flex; flex-direction: column; gap: 4px;
    transition: opacity 0.3s ease;
    z-index: 10;
  }
  .controls-bar.hidden { opacity: 0; pointer-events: none; }

  /* seek */
  .seek-row { display: flex; align-items: center; gap: 8px; }

  .seek-bar {
    flex: 1; height: 4px;
    -webkit-appearance: none; appearance: none;
    background: rgba(255,255,255,0.15);
    border-radius: 2px; cursor: pointer; outline: none;
    transition: height 0.15s;
  }
  .seek-bar:hover { height: 6px; }
  .seek-bar::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 13px; height: 13px;
    background: #fff; border-radius: 50%;
    cursor: pointer; box-shadow: 0 0 4px rgba(0,0,0,0.6);
  }

  .time-display {
    color: #999; font-size: 12px;
    font-variant-numeric: tabular-nums; white-space: nowrap;
  }

  /* bottom row */
  .bottom-row { display: flex; align-items: center; gap: 4px; }

  .ctrl-btn {
    background: none; border: none; color: #aaa;
    cursor: pointer; padding: 5px; border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    transition: color 0.15s, background 0.15s; flex-shrink: 0;
  }
  .ctrl-btn:hover { color: #fff; background: rgba(255,255,255,0.08); }

  .volume-wrap { display: flex; align-items: center; gap: 5px; }

  .volume-bar {
    width: 72px; height: 4px;
    -webkit-appearance: none; appearance: none;
    background: rgba(255,255,255,0.15);
    border-radius: 2px; cursor: pointer; outline: none;
  }
  .volume-bar::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 12px; height: 12px;
    background: #fff; border-radius: 50%; cursor: pointer;
  }

  .spacer { flex: 1; }

  /* ── SETTINGS MENU ── */
  .settings-menu {
    position: absolute;
    bottom: 62px; right: 14px;
    background: rgba(18,18,18,0.97);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 8px; padding: 6px 0;
    min-width: 165px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.8);
    z-index: 30; display: none;
    backdrop-filter: blur(10px);
  }
  .settings-menu.open { display: block; }

  .settings-section-title {
    padding: 6px 14px 4px;
    color: #555; font-size: 11px;
    text-transform: uppercase; letter-spacing: 0.08em;
  }
  .settings-option {
    display: flex; align-items: center; gap: 10px;
    padding: 7px 14px; color: #aaa; font-size: 13px;
    cursor: pointer; transition: background 0.1s;
  }
  .settings-option:hover { background: rgba(255,255,255,0.06); color: #fff; }
  .settings-option.danger { color: #ff6b6b; }
  .settings-option.danger:hover { background: rgba(255,80,80,0.08); color: #ff8a8a; }
  .settings-divider { height: 1px; background: rgba(255,255,255,0.07); margin: 4px 0; }

  .speed-dot {
    width: 9px; height: 9px; border-radius: 50%;
    border: 1.5px solid #444; flex-shrink: 0;
    transition: background 0.15s, border-color 0.15s;
  }
  .speed-dot.active { background: #29b6f6; border-color: #29b6f6; }

  /* ── FULLSCREEN PICKER ── */
  .fs-picker {
    position: absolute;
    bottom: 62px; right: 56px;
    background: rgba(18,18,18,0.97);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 8px; padding: 6px 0;
    min-width: 150px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.8);
    z-index: 30; display: none;
    backdrop-filter: blur(10px);
  }
  .fs-picker.open { display: block; }
  .fs-picker-title {
    padding: 6px 14px 4px;
    color: #555; font-size: 11px;
    text-transform: uppercase; letter-spacing: 0.08em;
  }
  .fs-option {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 14px; color: #aaa; font-size: 13px;
    cursor: pointer; transition: background 0.1s;
  }
  .fs-option:hover { background: rgba(255,255,255,0.06); color: #fff; }

  /* ── DOWNLOAD PICKER ── */
  .dl-picker {
    position: absolute;
    bottom: 62px; right: 100px;
    background: rgba(18,18,18,0.97);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 8px; padding: 6px 0;
    min-width: 160px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.8);
    z-index: 30; display: none;
    backdrop-filter: blur(10px);
  }
  .dl-picker.open { display: block; }
  .dl-picker-title {
    padding: 6px 14px 4px;
    color: #555; font-size: 11px;
    text-transform: uppercase; letter-spacing: 0.08em;
  }
  .dl-option {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 14px; color: #aaa; font-size: 13px;
    cursor: pointer; transition: background 0.1s;
  }
  .dl-option:hover { background: rgba(255,255,255,0.06); color: #fff; }

  /* ── GUEST DISABLED ── */
  .ctrl-btn.disabled { opacity: 0.3; cursor: default; }
  .ctrl-btn.disabled:hover { background: none; color: #aaa; }
  .volume-wrap.disabled .volume-bar { opacity: 0.3; pointer-events: none; }
  .volume-wrap.disabled .ctrl-btn { opacity: 0.3; cursor: default; }
  .volume-wrap.disabled .ctrl-btn:hover { background: none; color: #aaa; }

  /* ── GUEST TOOLTIP ── */
  .guest-tooltip {
    position: fixed;
    background: rgba(18,18,18,0.97);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px; padding: 10px 14px;
    color: #fff; font-size: 13px; line-height: 1.5;
    pointer-events: none; z-index: 9999; max-width: 240px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.7);
    opacity: 0; transition: opacity 0.15s;
    backdrop-filter: blur(8px);
  }
  .guest-tooltip.visible { opacity: 1; pointer-events: auto; }
  .guest-tooltip .tt-action {
    color: #29b6f6; font-size: 12px; cursor: pointer;
    margin-top: 5px; display: block;
  }
  .guest-tooltip .tt-action:hover { text-decoration: underline; }

  /* ── LOGIN MODAL ── */
  .modal-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.75);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000; opacity: 0; pointer-events: none;
    transition: opacity 0.2s; backdrop-filter: blur(5px);
  }
  .modal-backdrop.open { opacity: 1; pointer-events: auto; }

  .modal {
    background: #161616;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px; padding: 32px 28px;
    width: 100%; max-width: 340px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.9);
    transform: translateY(10px); transition: transform 0.2s;
  }
  .modal-backdrop.open .modal { transform: translateY(0); }

  .modal-title { color: #fff; font-size: 18px; font-weight: 600; margin-bottom: 6px; }
  .modal-subtitle { color: #666; font-size: 13px; margin-bottom: 24px; }

  .modal-field { margin-bottom: 16px; }
  .modal-field label {
    display: block; color: #777; font-size: 12px;
    text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 6px;
  }
  .modal-field input[type="text"],
  .modal-field input[type="password"] {
    width: 100%; background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 6px; padding: 10px 12px;
    color: #fff; font-size: 14px; outline: none;
    transition: border-color 0.15s; font-family: inherit;
  }
  .modal-field input:focus { border-color: #29b6f6; }

  .modal-checkbox {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 24px; cursor: pointer;
  }
  .modal-checkbox input { accent-color: #29b6f6; cursor: pointer; }
  .modal-checkbox span { color: #888; font-size: 13px; }

  .modal-error { color: #ff6b6b; font-size: 12px; margin-bottom: 14px; min-height: 16px; }

  .modal-btn {
    width: 100%; padding: 11px;
    background: #29b6f6; border: none; border-radius: 6px;
    color: #000; font-size: 14px; font-weight: 700;
    cursor: pointer; transition: background 0.15s; font-family: inherit;
  }
  .modal-btn:hover { background: #4fc3f7; }

  .modal-cancel {
    width: 100%; padding: 9px;
    background: none; border: 1px solid rgba(255,255,255,0.1);
    border-radius: 6px; color: #666; font-size: 13px;
    cursor: pointer; margin-top: 8px;
    transition: border-color 0.15s, color 0.15s; font-family: inherit;
  }
  .modal-cancel:hover { border-color: rgba(255,255,255,0.25); color: #bbb; }

  /* fullscreen overrides */
  :fullscreen .dual-wrap,
  :-webkit-full-screen .dual-wrap { width: 100vw; height: 100vh; }

  /* ── PLAY HINT WAVE ── */
  .play-hint {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 14px;
    pointer-events: none;
    z-index: 8;
    opacity: 0;
    transition: opacity 0.5s ease;
    cursor: pointer;
    background: rgba(0,0,0,0.28);
  }
  .play-hint.visible { opacity: 1; pointer-events: auto; }

  .play-hint-inner {
    position: relative;
    width: 80px; height: 80px;
    display: flex; align-items: center; justify-content: center;
  }

  /* wave rings emanating outward */
  .play-hint-ring {
    position: absolute;
    width: 80px; height: 80px;
    border-radius: 50%;
    border: 2px solid #29b6f6;
    animation: waveOut 2.1s cubic-bezier(0.2, 0.6, 0.4, 1) infinite;
    opacity: 0;
  }
  .play-hint-ring:nth-child(1) { animation-delay: 0s; }
  .play-hint-ring:nth-child(2) { animation-delay: 0.7s; }
  .play-hint-ring:nth-child(3) { animation-delay: 1.4s; }

  @keyframes waveOut {
    0%   { transform: scale(1);   opacity: 0.8; }
    80%  { transform: scale(2.6); opacity: 0; }
    100% { transform: scale(2.6); opacity: 0; }
  }

  /* center play button */
  .play-hint-icon {
    position: relative; z-index: 2;
    width: 60px; height: 60px;
    background: rgba(41, 182, 246, 0.15);
    border: 2px solid #29b6f6;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(6px);
    box-shadow: 0 0 24px rgba(41,182,246,0.3), inset 0 0 12px rgba(41,182,246,0.1);
    transition: transform 0.15s, background 0.15s;
  }
  .play-hint:hover .play-hint-icon {
    transform: scale(1.1);
    background: rgba(41, 182, 246, 0.28);
  }

  .play-hint-icon svg {
    margin-left: 4px;
    color: #29b6f6;
    filter: drop-shadow(0 0 8px rgba(41,182,246,0.9));
  }

  .play-hint-label {
    color: rgba(255,255,255,0.65);
    font-size: 12px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    text-shadow: 0 1px 4px rgba(0,0,0,0.8);
  }
</style>
</head>
<body>

<!-- LOGIN MODAL -->
<div class="modal-backdrop" id="loginModal">
  <div class="modal">
    <div class="modal-title">Přihlášení</div>
    <div class="modal-subtitle">Pro přístup ke všem funkcím se přihlaste.</div>
    <div class="modal-field">
      <label>Uživatelské jméno</label>
      <input type="text" id="loginUser" autocomplete="username" placeholder="uživatel">
    </div>
    <div class="modal-field">
      <label>Heslo</label>
      <input type="password" id="loginPass" autocomplete="current-password" placeholder="••••••••">
    </div>
    <label class="modal-checkbox">
      <input type="checkbox" id="rememberMe">
      <span>Zapamatovat pro toto zařízení</span>
    </label>
    <div class="modal-error" id="loginError"></div>
    <button class="modal-btn" onclick="submitLogin()">Přihlásit se</button>
    <button class="modal-cancel" onclick="closeLogin()">Zrušit</button>
  </div>
</div>

<!-- GUEST TOOLTIP -->
<div class="guest-tooltip" id="guestTooltip">
  <span id="ttMsg"></span>
  <span class="tt-action" onclick="openLogin()">Změnit účet</span>
</div>

<!-- DUAL PLAYER -->
<div class="dual-wrap" id="dualWrap">

  <div class="video-stage" id="videoStage" style="position:relative">
    <div class="play-hint" id="playHint">
      <div class="play-hint-inner">
        <div class="play-hint-ring"></div>
        <div class="play-hint-ring"></div>
        <div class="play-hint-ring"></div>
        <div class="play-hint-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="6,3 20,12 6,21"/></svg>
        </div>
      </div>
      <span class="play-hint-label">Klikněte pro spuštění</span>
    </div>
    <!-- Outdoor -->
    <div class="video-cell" id="cellOutdoor">
      <span class="cell-label">Outdoor</span>
      <video id="vidOutdoor" playsinline></video>
    </div>
    <!-- Indoor -->
    <div class="video-cell" id="cellIndoor">
      <span class="cell-label">Indoor</span>
      <video id="vidIndoor" playsinline></video>
    </div>
  </div>

  <!-- SHARED CONTROLS -->
  <div class="controls-bar" id="controlsBar">
    <div class="seek-row">
      <input type="range" class="seek-bar" id="seekBar" min="0" max="100" value="0" step="0.1">
      <span class="time-display" id="timeDisplay">0:00 / 0:00</span>
    </div>
    <div class="bottom-row">
      <!-- Play/Pause -->
      <button class="ctrl-btn" onclick="togglePlay()">
        <svg id="playIcon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <polygon points="5,3 19,12 5,21"/>
        </svg>
      </button>

      <!-- Volume -->
      <div class="volume-wrap" id="volWrap">
        <button class="ctrl-btn" onclick="toggleMute()">
          <svg id="volIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
          </svg>
        </button>
        <input type="range" class="volume-bar" id="volumeBar" min="0" max="1" step="0.01" value="1">
      </div>

      <div class="spacer"></div>

      <!-- Settings -->
      <button class="ctrl-btn" id="settingsBtn" onclick="toggleSettings()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"/>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
      </button>

      <!-- Download picker btn -->
      <button class="ctrl-btn" id="dlBtn" onclick="toggleDlPicker()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
      </button>

      <!-- Fullscreen: main btn = both, chevron = picker -->
      <div style="display:flex;align-items:center;gap:0">
        <button class="ctrl-btn" id="fsBtn" onclick="toggleFullscreenBoth()" title="Celá obrazovka / zpět">
          <svg id="fsIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 3 21 3 21 9"/>
            <polyline points="9 21 3 21 3 15"/>
            <line x1="21" y1="3" x2="14" y2="10"/>
            <line x1="3" y1="21" x2="10" y2="14"/>
          </svg>
        </button>
        <button class="ctrl-btn" id="fsPickerBtn" onclick="toggleFsPicker()" title="Vybrat kameru" style="padding:3px 2px">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- SETTINGS MENU -->
  <div class="settings-menu" id="settingsMenu">
    <div class="settings-section-title">Rychlost</div>
    <div class="settings-option" onclick="setSpeed(0.5)"><span class="speed-dot" data-speed="0.5"></span>0.5×</div>
    <div class="settings-option" onclick="setSpeed(0.75)"><span class="speed-dot" data-speed="0.75"></span>0.75×</div>
    <div class="settings-option" onclick="setSpeed(1)"><span class="speed-dot active" data-speed="1"></span>Normal</div>
    <div class="settings-option" onclick="setSpeed(1.25)"><span class="speed-dot" data-speed="1.25"></span>1.25×</div>
    <div class="settings-option" onclick="setSpeed(1.5)"><span class="speed-dot" data-speed="1.5"></span>1.5×</div>
    <div class="settings-option" onclick="setSpeed(1.75)"><span class="speed-dot" data-speed="1.75"></span>1.75×</div>
    <div class="settings-option" onclick="setSpeed(2)"><span class="speed-dot" data-speed="2"></span>2×</div>
    <div class="settings-option" onclick="setSpeed(4)"><span class="speed-dot" data-speed="4"></span>4×</div>
    <div class="settings-divider" id="logoutDivider" style="display:none"></div>
    <div class="settings-option danger" id="logoutBtn" style="display:none" onclick="logout()">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
        <polyline points="16 17 21 12 16 7"/>
        <line x1="21" y1="12" x2="9" y2="12"/>
      </svg>
      Odhlásit se
    </div>
  </div>

  <!-- DOWNLOAD PICKER -->
  <div class="dl-picker" id="dlPicker">
    <div class="dl-picker-title">Stáhnout</div>
    <div class="dl-option" onclick="doDownload('indoor')">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Indoor
    </div>
    <div class="dl-option" onclick="doDownload('outdoor')">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Outdoor
    </div>
  </div>

  <!-- FULLSCREEN PICKER -->
  <div class="fs-picker" id="fsPicker">
    <div class="fs-picker-title">Celá obrazovka</div>
    <div class="fs-option" onclick="selectFsMode('both')">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="8" height="8" rx="1"/>
        <rect x="13" y="3" width="8" height="8" rx="1"/>
        <rect x="3" y="13" width="8" height="8" rx="1"/>
        <rect x="13" y="13" width="8" height="8" rx="1"/>
      </svg>
      Obě kamery
    </div>
    <div class="fs-option" onclick="selectFsMode('indoor')">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/>
        <line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/>
      </svg>
      Indoor
    </div>
    <div class="fs-option" onclick="selectFsMode('outdoor')">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/>
        <line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/>
      </svg>
      Outdoor
    </div>
  </div>

</div><!-- end dual-wrap -->

<script>
  // ── ELEMENTS ────────────────────────────────────────────────────
  const vidIndoor  = document.getElementById('vidIndoor');
  const vidOutdoor = document.getElementById('vidOutdoor');
  const seekBar    = document.getElementById('seekBar');
  const timeDisp   = document.getElementById('timeDisplay');
  const playIcon   = document.getElementById('playIcon');
  const volIcon    = document.getElementById('volIcon');
  const volumeBar  = document.getElementById('volumeBar');
  const controlsBar = document.getElementById('controlsBar');
  const dualWrap   = document.getElementById('dualWrap');
  const volWrap    = document.getElementById('volWrap');
  const dlBtn      = document.getElementById('dlBtn');
  const tooltip    = document.getElementById('guestTooltip');
  const ttMsg      = document.getElementById('ttMsg');
  const loginModal = document.getElementById('loginModal');

  // master = vidIndoor (leads seek bar and time display)
  const master = vidIndoor;

  // ── AUTH ─────────────────────────────────────────────────────────
  const VALID_USER  = 'user';
  const VALID_PASS  = 'pass';
  const REMEMBER_KEY = 'secreet';

  let currentUser = 'guest';
  let isGuestActive = true;

  try {
    const saved = localStorage.getItem(REMEMBER_KEY);
    if (saved) {
      const { user } = JSON.parse(saved);
      if (user === VALID_USER) { currentUser = user; isGuestActive = false; }
    }
  } catch(e) {}

  function updateLogoutVisibility() {
    const show = !isGuestActive;
    document.getElementById('logoutDivider').style.display = show ? 'block' : 'none';
    document.getElementById('logoutBtn').style.display     = show ? 'flex'  : 'none';
  }

  // ── URL PARAMS ───────────────────────────────────────────────────
  const M3U8_BASE = 'https://wedos.jtechdev.cz/nvr/m3u8/';
  const MP4_BASE  = 'https://wedos.jtechdev.cz/nvr/';
  const params    = new URLSearchParams(window.location.search);

  const indoorParam  = params.get('indoor')  || '';
  const outdoorParam = params.get('outdoor') || '';
  // cdelay: positive = indoor is ahead = outdoor starts CDELAY seconds in
  //          negative = outdoor is ahead = indoor starts |CDELAY| seconds in
  const CDELAY    = parseFloat(params.get('cdelay') || '0');

  const INDOOR_M3U8  = indoorParam  ? M3U8_BASE + indoorParam  : '';
  const OUTDOOR_M3U8 = outdoorParam ? M3U8_BASE + outdoorParam : '';
  const INDOOR_MP4   = indoorParam  ? MP4_BASE  + indoorParam.replace(/\.m3u8$/i, '.mp4') : '';
  const OUTDOOR_MP4  = outdoorParam ? MP4_BASE  + outdoorParam.replace(/\.m3u8$/i, '.mp4') : '';

  // ── HLS LOADER ───────────────────────────────────────────────────
  let hlsIndoor = null, hlsOutdoor = null;
  let indoorReady = false, outdoorReady = false;

  function loadHls(url, videoEl, onReady) {
    if (!url) { onReady(); return null; }
    if (Hls.isSupported()) {
      const h = new Hls({ autoStartLoad: true });
      h.loadSource(url);
      h.attachMedia(videoEl);
      // Seek to first frame immediately so poster shows
      h.on(Hls.Events.MANIFEST_PARSED, () => {
        onReady();
      });
      return h;
    } else if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
      videoEl.src = url;
      videoEl.addEventListener('loadedmetadata', () => {
        onReady();
      }, { once: true });
      return null;
    }
    return null;
  }

  hlsIndoor  = loadHls(INDOOR_M3U8,  vidIndoor,  () => { indoorReady  = true; });
  hlsOutdoor = loadHls(OUTDOOR_M3U8, vidOutdoor, () => { outdoorReady = true; });

  // ── PLAY HINT ────────────────────────────────────────────────────
  const playHint = document.getElementById('playHint');

  function showPlayHint() {
    playHint.classList.add('visible');
    // clicking anywhere on video stage (including the hint overlay) triggers play
    document.getElementById('videoStage').addEventListener('click', onHintClick, { once: true });
    playHint.addEventListener('click', onHintClick, { once: true });
  }

  function hidePlayHint() {
    playHint.classList.remove('visible');
  }

  function onHintClick() {
    waitAndPlay(doPlay);
  }

  // ── PLAY LOGIC ──────────────────────────────────────────────────
  let playStarted = false;

  function doPlay() {
    if (playStarted) return;
    playStarted = true;

    hidePlayHint();

    vidIndoor.muted  = true;
    vidOutdoor.muted = true;

    // Cut the start of whichever video is "ahead"
    // CDELAY > 0: indoor is ahead → outdoor skips forward by CDELAY
    // CDELAY < 0: outdoor is ahead → indoor skips forward by |CDELAY|
    vidIndoor.currentTime  = CDELAY < 0 ? -CDELAY : 0;
    vidOutdoor.currentTime = CDELAY > 0 ?  CDELAY : 0;

    const p1 = INDOOR_M3U8  ? vidIndoor.play().catch(() => {})  : Promise.resolve();
    const p2 = OUTDOOR_M3U8 ? vidOutdoor.play().catch(() => {}) : Promise.resolve();

    Promise.all([p1, p2]).then(() => {
      if (!isGuestActive) {
        vidIndoor.muted  = false;
        vidIndoor.volume = 1;
        vidOutdoor.muted = true;
        volumeBar.value  = 1;
        updateVolFill();
        updateVolIcon();
      }
    });
  }

  function waitAndPlay(callback) {
    const bothReady = () => indoorReady && outdoorReady;
    if (bothReady()) { callback(); }
    else {
      const wait = setInterval(() => {
        if (bothReady()) { clearInterval(wait); callback(); }
      }, 80);
    }
  }

  // Once ready: show first frame at correct offset, then show hint
  waitAndPlay(() => {
    vidIndoor.currentTime  = indoorOffset();
    vidOutdoor.currentTime = outdoorOffset();
    showPlayHint();
  });

  // ── AUTO-HIDE CONTROLS ───────────────────────────────────────────
  let hideTimer = null;
  function showControls() {
    controlsBar.classList.remove('hidden');
    dualWrap.style.cursor = 'default';
    clearTimeout(hideTimer);
    hideTimer = setTimeout(() => {
      if (!master.paused) { controlsBar.classList.add('hidden'); dualWrap.style.cursor = 'none'; }
    }, 2500);
  }
  dualWrap.addEventListener('mousemove',  showControls);
  dualWrap.addEventListener('mouseenter', showControls);
  dualWrap.addEventListener('mouseleave', () => {
    clearTimeout(hideTimer);
    if (!master.paused) { controlsBar.classList.add('hidden'); dualWrap.style.cursor = 'none'; }
  });
  master.addEventListener('pause', () => { clearTimeout(hideTimer); controlsBar.classList.remove('hidden'); dualWrap.style.cursor = 'default'; });
  master.addEventListener('play',  showControls);

  // ── SEEK ─────────────────────────────────────────────────────────
  // After cutting the start, both videos run in sync from their own offset.
  // "Effective duration" = video.duration minus its start offset.
  // Seek bar represents shared timeline (0 = both start playing together).

  function indoorOffset()  { return CDELAY < 0 ? -CDELAY : 0; }
  function outdoorOffset() { return CDELAY > 0 ?  CDELAY : 0; }

  function sharedDuration() {
    // Duration of the longer clip after cutting
    const di = (vidIndoor.duration  || 0) - indoorOffset();
    const do_ = (vidOutdoor.duration || 0) - outdoorOffset();
    return Math.max(di, do_, 0);
  }

  master.addEventListener('timeupdate', () => {
    if (!master.duration) return;
    const total = sharedDuration();
    if (!total) return;
    // shared time = indoor.currentTime - indoorOffset
    const shared = master.currentTime - indoorOffset();
    const pct = Math.min(100, Math.max(0, (shared / total) * 100));
    seekBar.value = pct;
    seekBar.style.background = `linear-gradient(to right, #fff ${pct}%, rgba(255,255,255,0.15) ${pct}%)`;
    const fmt = t => `${Math.floor(t/60)}:${String(Math.floor(t%60)).padStart(2,'0')}`;
    timeDisp.textContent = `${fmt(shared)} / ${fmt(total)}`;
  });

  seekBar.addEventListener('input', () => {
    const total = sharedDuration();
    if (!total) return;
    const shared = (seekBar.value / 100) * total;
    const newIndoor  = Math.min(vidIndoor.duration  || Infinity, shared + indoorOffset());
    const newOutdoor = Math.min(vidOutdoor.duration || Infinity, shared + outdoorOffset());
    vidIndoor.currentTime  = newIndoor;
    vidOutdoor.currentTime = newOutdoor;
    if (!master.paused) {
      if (vidIndoor.ended  && newIndoor  < (vidIndoor.duration  || 0)) vidIndoor.play().catch(()=>{});
      if (vidOutdoor.ended && newOutdoor < (vidOutdoor.duration || 0)) vidOutdoor.play().catch(()=>{});
    }
  });

  // ── PLAY / PAUSE ─────────────────────────────────────────────────
  function togglePlay() {
    if (master.paused) {
      vidIndoor.play().catch(() => {}); vidOutdoor.play().catch(() => {});
    } else {
      vidIndoor.pause(); vidOutdoor.pause();
    }
  }

  // click on either video cell
  document.getElementById('cellIndoor').addEventListener('click',  togglePlay);
  document.getElementById('cellOutdoor').addEventListener('click', togglePlay);

  master.addEventListener('play',  () => { playIcon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>'; });
  master.addEventListener('pause', () => { playIcon.innerHTML = '<polygon points="5,3 19,12 5,21"/>'; });

  // Drift correction: keep outdoor in sync with indoor's shared timeline
  master.addEventListener('timeupdate', () => {
    if (vidOutdoor.ended || vidOutdoor.paused) return;
    const shared   = master.currentTime - indoorOffset();
    const expected = shared + outdoorOffset();
    const outdoorMax = vidOutdoor.duration || Infinity;
    const clamped = Math.min(Math.max(0, expected), outdoorMax);
    if (Math.abs(vidOutdoor.currentTime - clamped) > 0.4) {
      vidOutdoor.currentTime = clamped;
    }
  });

  // When either video ends, pause at last frame (don't loop)
  vidIndoor.addEventListener('ended', () => {
    vidIndoor.pause();
    vidOutdoor.pause();
  });
  vidOutdoor.addEventListener('ended', () => {
    // outdoor ended but indoor may still have frames - keep playing indoor
    // outdoor stays on last frame naturally (no loop attr)
  });

  // ── VOLUME ───────────────────────────────────────────────────────
  function updateVolFill() {
    const pct = volumeBar.value * 100;
    volumeBar.style.background = `linear-gradient(to right, #fff ${pct}%, rgba(255,255,255,0.15) ${pct}%)`;
  }
  volumeBar.addEventListener('input', () => {
    if (isGuestActive) return;
    vidIndoor.volume = volumeBar.value; vidIndoor.muted = false;
    updateVolFill(); updateVolIcon();
  });
  updateVolFill();

  function toggleMute() {
    if (isGuestActive) return;
    vidIndoor.muted = !vidIndoor.muted; updateVolIcon();
  }
  function updateVolIcon() {
    volIcon.innerHTML = (vidIndoor.muted || vidIndoor.volume === 0)
      ? `<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
         <line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>`
      : `<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
         <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
         <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>`;
  }

  // ── SPEED ────────────────────────────────────────────────────────
  function setSpeed(rate) {
    vidIndoor.playbackRate = vidOutdoor.playbackRate = rate;
    document.querySelectorAll('.speed-dot').forEach(d => d.classList.toggle('active', parseFloat(d.dataset.speed) === rate));
    closeAll();
  }

  // ── MENUS ────────────────────────────────────────────────────────
  function closeAll() {
    document.getElementById('settingsMenu').classList.remove('open');
    document.getElementById('fsPicker').classList.remove('open');
    document.getElementById('dlPicker').classList.remove('open');
  }
  function toggleSettings()  { const m = document.getElementById('settingsMenu'); const wasOpen = m.classList.contains('open'); closeAll(); if (!wasOpen) m.classList.add('open'); }
  function toggleFsPicker()  { const m = document.getElementById('fsPicker');    const wasOpen = m.classList.contains('open'); closeAll(); if (!wasOpen) m.classList.add('open'); }
  function toggleDlPicker()  {
    if (isGuestActive) return;
    const m = document.getElementById('dlPicker'); const wasOpen = m.classList.contains('open'); closeAll(); if (!wasOpen) m.classList.add('open');
  }

  document.addEventListener('click', e => {
    const inSettings = document.getElementById('settingsBtn').contains(e.target) || document.getElementById('settingsMenu').contains(e.target);
    const inFs       = document.getElementById('fsBtn').contains(e.target) || document.getElementById('fsPickerBtn').contains(e.target) || document.getElementById('fsPicker').contains(e.target);
    const inDl       = document.getElementById('dlBtn').contains(e.target)       || document.getElementById('dlPicker').contains(e.target);
    if (!inSettings && !inFs && !inDl) closeAll();
  });

  // ── FULLSCREEN ───────────────────────────────────────────────────
  let fsMode = 'both'; // 'both' | 'indoor' | 'outdoor'

  // Called from picker – just set mode and update layout, don't enter fullscreen
  function selectFsMode(mode) {
    fsMode = mode;
    closeAll();
    applyFsLayout();
    // If already in fullscreen, just apply layout. If not, do nothing.
    // Main fs button handles actually entering fullscreen.
  }

  function applyFsLayout() {
    const cellIn  = document.getElementById('cellIndoor');
    const cellOut = document.getElementById('cellOutdoor');
    if (fsMode === 'indoor') {
      cellOut.style.display = 'none';
      cellIn.style.display  = '';
    } else if (fsMode === 'outdoor') {
      cellIn.style.display  = 'none';
      cellOut.style.display = '';
    } else {
      cellIn.style.display  = '';
      cellOut.style.display = '';
    }
  }

  function enterFullscreen(mode) {
    if (mode) fsMode = mode;
    closeAll();
    applyFsLayout();
    if (!document.fullscreenElement) {
      (dualWrap.requestFullscreen || dualWrap.webkitRequestFullscreen).call(dualWrap);
    }
  }

  function exitFullscreen() {
    if (document.fullscreenElement) {
      (document.exitFullscreen || document.webkitExitFullscreen).call(document);
    }
  }

  // Toggle: if already fullscreen → exit, else enter
  function toggleFullscreenBoth() {
    if (document.fullscreenElement) {
      exitFullscreen();
    } else {
      enterFullscreen('both');
    }
  }

  document.addEventListener('fullscreenchange', () => {
    const fsIcon = document.getElementById('fsIcon');
    if (!document.fullscreenElement) {
      // Restore both cells and reset mode when exiting
      fsMode = 'both';
      document.getElementById('cellIndoor').style.display  = '';
      document.getElementById('cellOutdoor').style.display = '';
      fsIcon.innerHTML = `<polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/>
        <line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/>`;
    } else {
      fsIcon.innerHTML = `<polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/>
        <line x1="10" y1="14" x2="3" y2="21"/><line x1="21" y1="3" x2="14" y2="10"/>`;
    }
  });

  // ── DOWNLOAD ─────────────────────────────────────────────────────
  async function doDownload(which) {
    closeAll();
    if (isGuestActive) return;
    const url = which === 'indoor' ? INDOOR_MP4 : OUTDOOR_MP4;
    if (!url) { alert('URL pro stažení není nastavena.'); return; }
    const filename = url.split('/').pop();
    try {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const blob = await resp.blob();
      const blobUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = blobUrl; a.download = filename;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(blobUrl), 10000);
    } catch(e) {
      alert('Stažení selhalo: ' + e.message);
    }
  }

  // ── GUEST TOOLTIP ────────────────────────────────────────────────
  let ttHideTimer = null;
  function showGuestTooltip(e) {
    ttMsg.textContent = `Uživatel ${currentUser} nemá právo využívat funkci.`;
    clearTimeout(ttHideTimer); tooltip.classList.add('visible'); positionTooltip(e);
  }
  function positionTooltip(e) {
    const tw = tooltip.offsetWidth || 240, th = tooltip.offsetHeight || 72;
    tooltip.style.left = Math.min(e.clientX + 12, window.innerWidth  - tw - 10) + 'px';
    tooltip.style.top  = Math.max(e.clientY - th - 10, 8) + 'px';
  }
  function hideGuestTooltip() { ttHideTimer = setTimeout(() => tooltip.classList.remove('visible'), 200); }
  tooltip.addEventListener('mouseenter', () => clearTimeout(ttHideTimer));
  tooltip.addEventListener('mouseleave', () => tooltip.classList.remove('visible'));

  function attachGuestHandlers() {
    volWrap.addEventListener('mouseenter', gVE); volWrap.addEventListener('mousemove', gVM);
    volWrap.addEventListener('mouseleave', hideGuestTooltip); volWrap.addEventListener('click', gBlock, true);
    dlBtn.addEventListener('mouseenter', gDE);   dlBtn.addEventListener('mousemove', gDM);
    dlBtn.addEventListener('mouseleave', hideGuestTooltip);  dlBtn.addEventListener('click', gBlock, true);
  }
  function detachGuestHandlers() {
    volWrap.removeEventListener('mouseenter', gVE); volWrap.removeEventListener('mousemove', gVM);
    volWrap.removeEventListener('mouseleave', hideGuestTooltip); volWrap.removeEventListener('click', gBlock, true);
    dlBtn.removeEventListener('mouseenter', gDE);   dlBtn.removeEventListener('mousemove', gDM);
    dlBtn.removeEventListener('mouseleave', hideGuestTooltip);  dlBtn.removeEventListener('click', gBlock, true);
  }
  function gVE(e){showGuestTooltip(e);} function gVM(e){positionTooltip(e);}
  function gDE(e){showGuestTooltip(e);} function gDM(e){positionTooltip(e);}
  function gBlock(e){e.stopPropagation();e.preventDefault();}

  // ── APPLY GUEST STATE ────────────────────────────────────────────
  function applyGuestState(active) {
    if (active) {
      [vidIndoor, vidOutdoor].forEach(v => { v.muted = true; v.volume = 0; });
      volumeBar.value = 0; updateVolFill(); updateVolIcon();
      volWrap.classList.add('disabled'); dlBtn.classList.add('disabled');
      attachGuestHandlers();
    } else {
      volWrap.classList.remove('disabled'); dlBtn.classList.remove('disabled');
      detachGuestHandlers(); tooltip.classList.remove('visible');
      vidIndoor.muted = false; vidIndoor.volume = 1;
      vidOutdoor.muted = true; // only indoor plays audio
      volumeBar.value = 1; updateVolFill(); updateVolIcon();
    }
    updateLogoutVisibility();
  }

  // ── LOGIN ────────────────────────────────────────────────────────
  function openLogin() {
    tooltip.classList.remove('visible');
    document.getElementById('loginUser').value = '';
    document.getElementById('loginPass').value = '';
    document.getElementById('loginError').textContent = '';
    document.getElementById('rememberMe').checked = false;
    loginModal.classList.add('open');
    setTimeout(() => document.getElementById('loginUser').focus(), 100);
  }
  function closeLogin() { loginModal.classList.remove('open'); }

  function submitLogin() {
    const user = document.getElementById('loginUser').value.trim();
    const pass = document.getElementById('loginPass').value;
    const remember = document.getElementById('rememberMe').checked;
    const errEl = document.getElementById('loginError');
    if (user === VALID_USER && pass === VALID_PASS) {
      currentUser = user; isGuestActive = false;
      if (remember) { try { localStorage.setItem(REMEMBER_KEY, JSON.stringify({ user })); } catch(e) {} }
      applyGuestState(false); closeLogin();
    } else {
      errEl.textContent = 'Nesprávné uživatelské jméno nebo heslo.';
      document.getElementById('loginPass').value = '';
      document.getElementById('loginPass').focus();
    }
  }
  document.getElementById('loginPass').addEventListener('keydown', e => { if (e.key === 'Enter') submitLogin(); });
  document.getElementById('loginUser').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('loginPass').focus(); });

  // ── LOGOUT ───────────────────────────────────────────────────────
  function logout() {
    try { localStorage.removeItem(REMEMBER_KEY); } catch(e) {}
    currentUser = 'guest'; isGuestActive = true;
    applyGuestState(true); closeAll();
  }

  // ── INIT ─────────────────────────────────────────────────────────
  applyGuestState(isGuestActive);
</script>
</body>
</html>
